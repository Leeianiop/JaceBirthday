<script>
/* ========= Base setup ========= */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

/* Cycle text (added apology here ❤️) */
const texts = [
  "Happy 46th Birthday Daddy",
  "Happy 46th Birthday Jace",
  "Happy 46th Birthday Lee",
  "Hapi Bday Mah N-",

];
let textIndex = 0;
document.getElementById('birthdayText').addEventListener('click', () => {
  textIndex = (textIndex + 1) % texts.length;
  document.getElementById('birthdayText').innerText = texts[textIndex];
});

/* ========= Countdown ========= */
function getTargetDates() {
  const now = new Date();
  const eventDay = new Date(now.getFullYear(), 7, 18); // Aug 18
  const nextBirthday = new Date(now.getFullYear() + 1, 7, 18);
  if (now < eventDay) return { phase: "event", target: eventDay, next: nextBirthday };
  return { phase: "birthday", target: nextBirthday, next: new Date(now.getFullYear() + 2, 7, 18) };
}
let countdownState = getTargetDates();

/* ========= Input ========= */
const keys = {};
document.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
document.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

/* ========= Images ========= */
function loadImage(src) {
  const img = new Image();
  img.src = src;
  return img;
}
const playerRightFrames = [loadImage('right 1.png'), loadImage('right 2.png')];
const playerLeftFrames  = [loadImage('left 1.png'),  loadImage('left 2.png')];
const cakeFrames        = [loadImage('cake normal.png'), loadImage('cake eaten.png')];
const buttonImage       = loadImage('button.png');
const npcImage          = loadImage('mom.png');
const planeImage        = loadImage('plane.png');
const specialImage      = loadImage('pixil-frame-0 (1).png');

/* ========= Game state ========= */
let player = {
  x: 400, y: 400, width: 200, height: 250,
  dir: 'right', frame: 0, frameTick: 0, jumping: false, vy: 0
};
let cake = { x: 800, y: 430, width: 200, height: 250, frame: 0 };

const playerSpeed = 10;
const groundY = 400;

let planeActive   = false;
let npcVisible    = false;
let npcSaidHi     = false;
let typedBuffer   = "";

let buttonX = 20, buttonY = 100, buttonW = 80, buttonH = 80;
let aPressCount = 0;
let specialActive = false;

/* ========= Helpers ========= */
function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

function safeDraw(img, x, y, w, h, color) {
  if (img && img.complete && img.naturalWidth > 0) {
    ctx.drawImage(img, x, y, w, h);
  } else {
    ctx.fillStyle = color;
    ctx.fillRect(x, y, w, h);
  }
}

function drawPlayer() {
  const frame = player.dir === 'right' ? playerRightFrames[player.frame] : playerLeftFrames[player.frame];
  safeDraw(frame, player.x, player.y, player.width, player.height, 'red');
}

function drawCake() {
  safeDraw(cakeFrames[cake.frame], cake.x, cake.y, cake.width, cake.height, 'pink');
  ctx.fillStyle = 'black';
  ctx.font = '24px Pacifico';
  ctx.fillText('(Press A to eat)', cake.x + 20, cake.y + 15);
}

function drawPlane() {
  safeDraw(planeImage, 650, 340, 350, 180, 'gray');
}

function drawSpecial() {
  safeDraw(specialImage, 400, 200, 400, 200, 'purple');
}

function drawNPC() {
  if (!npcVisible) return;
  const nx = 320, ny = 340, nw = 160, nh = 220;
  safeDraw(npcImage, nx, ny, nw, nh, 'orange');
  ctx.fillStyle = 'white';
  ctx.fillRect(nx + nw + 20, ny + 40, 140, 60);
  ctx.strokeStyle = 'black';
  ctx.strokeRect(nx + nw + 20, ny + 40, 140, 60);
  ctx.fillStyle = 'black';
  ctx.font = '26px Pacifico';
  ctx.fillText('Hi', nx + nw + 35, ny + 78);
}

function drawButton() {
  safeDraw(buttonImage, buttonX, buttonY, buttonW, buttonH, 'lightblue');
  ctx.strokeStyle = 'black';
  ctx.strokeRect(buttonX, buttonY, buttonW, buttonH);
}

/* ========= Mouse click ========= */
canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  if (mx > buttonX && mx < buttonX + buttonW && my > buttonY && my < buttonY + buttonH) {
    planeActive = true;
    npcVisible  = true;
    npcSaidHi   = true;
  }
});

/* ========= Keyboard ========= */
document.addEventListener('keydown', (e) => {
  const k = e.key.toLowerCase();

  if (!planeActive && k === 'a') {
    cake.frame = 1;
    setTimeout(() => { cake.frame = 0; }, 500);

    aPressCount++;
    if (aPressCount >= 15) specialActive = true;
  }

  if (k === 'arrowup' && !player.jumping) {
    player.jumping = true;
    player.vy = -15;
  }
});

/* Typing "hi" back */
document.addEventListener('keypress', (e) => {
  if (!npcVisible) return;
  typedBuffer += e.key;
  if (typedBuffer.length > 10) typedBuffer = typedBuffer.slice(-10);
  if (typedBuffer.toLowerCase().endsWith('hi')) {
    npcVisible = false;
    typedBuffer = '';
  }
});

/* ========= Game loop ========= */
function gameLoop() {
  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const now = new Date();
  if (now >= countdownState.target) {
    countdownState = { phase: "birthday", target: countdownState.next, next: new Date(countdownState.next.getFullYear() + 1, 7, 18) };
  }
  const diff = countdownState.target - now;
  const days = Math.floor(diff / (1000*60*60*24));
  const hours = Math.floor((diff / (1000*60*60)) % 24);
  const minutes = Math.floor((diff / (1000*60)) % 60);
  const seconds = Math.floor((diff / 1000) % 60);
  document.getElementById('countdown').innerText =
    `${days}d ${hours}h ${minutes}m ${seconds}s (${countdownState.phase})`;

  if (specialActive) drawSpecial();
  else if (planeActive) drawPlane();
  else drawCake();

  if (keys['arrowleft']) {
    player.x -= playerSpeed;
    player.dir = 'left';
    player.frameTick++;
  } else if (keys['arrowright']) {
    player.x += playerSpeed;
    player.dir = 'right';
    player.frameTick++;
  } else {
    player.frame = 0;
    player.frameTick = 0;
  }
  if (player.frameTick > 10) {
    player.frame = (player.frame + 1) % 2;
    player.frameTick = 0;
  }

  if (player.jumping) {
    player.y += player.vy;
    player.vy += 1;
    if (player.y >= groundY) {
      player.y = groundY;
      player.jumping = false;
      player.vy = 0;
    }
  }

  player.x = clamp(player.x, 0, canvas.width - player.width);
  player.y = clamp(player.y, 0, canvas.height - player.height);

  drawPlayer();
  drawNPC();
  drawButton();

  requestAnimationFrame(gameLoop);
}
gameLoop();

/* ========= Confetti ========= */
const confetti = document.getElementById('confetti');
const cctx = confetti.getContext('2d');
function sizeConfetti() {
  confetti.width = window.innerWidth;
  confetti.height = window.innerHeight;
}
sizeConfetti();
window.addEventListener('resize', sizeConfetti);

const pieces = Array.from({ length: 160 }).map(() => ({
  x: Math.random() * confetti.width,
  y: Math.random() * confetti.height,
  s: Math.random() * 6 + 4,
  v: Math.random() * 1.5 + 0.5,
  c: `hsl(${Math.random() * 360}, 100%, 50%)`,
  r: Math.random() * Math.PI
}));

function drawConfetti() {
  cctx.clearRect(0, 0, confetti.width, confetti.height);
  pieces.forEach(p => {
    cctx.save();
    cctx.translate(p.x, p.y);
    cctx.rotate(p.r);
    cctx.fillStyle = p.c;
    cctx.fillRect(-p.s / 2, -p.s / 2, p.s, p.s);
    cctx.restore();
    p.y += p.v * 2;
    p.r += 0.02;
    if (p.y > confetti.height + 20) {
      p.y = -20;
      p.x = Math.random() * confetti.width;
    }
  });
  requestAnimationFrame(drawConfetti);
}
drawConfetti();
</script>



